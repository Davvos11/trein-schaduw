<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>{{ trip }}: {{ from }} - {{ to }} - Zon in de trein</title>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css">

    <link rel="stylesheet" href="/static/common.css">
    <link rel="stylesheet" href="/static/result.css">
</head>
<body>
<textarea id="data" style="display: none" aria-hidden="true" aria-label="hidden">
    {{ result }}
</textarea>
<main class="container">
    <div class="info">
        <h2><span class="name">{{ journey.name }}</span>
            naar <span class="direction">{{ journey.direction }}</span>
            <span class="number text-secondary">({{ journey.number }})</span></h2>
        <a role="button" href="/" class="btn btn-primary">Terug</a>
    </div>
    <span id="duration" style="display: none;">{{ journey.duration }}</span>
    <nav class="nav nav-tabs" role="tablist">
        <a class="nav-link active" id="nav-vertical" data-bs-toggle="tab" href="#tab-vertical"
           role="tab" aria-controls="tab-vertical" aria-selected="false">
            Simpel
        </a>
        <a class="nav-link" id="nav-horizontal" data-bs-toggle="tab" href="#tab-horizontal"
           role="tab" aria-controls="tab-horizontal" aria-selected="true">
            Geavanceerd
        </a>
    </nav>
    <div class="tab-content" id="chart-tabs">
        <div class="tab-pane show active" id="tab-vertical" aria-labelledby="nav-vertical">
            <canvas id="chart-vertical"></canvas>
        </div>
        <div class="tab-pane" id="tab-horizontal" aria-labelledby="nav-horizontal">
            <canvas id="chart-horizontal"></canvas>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.9/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.1.0/dist/chartjs-plugin-annotation.min.js"></script>
<script>
    const unit = document.getElementById("data").value;
    /** @type Array<object> */
    const raw_data = JSON.parse(unit);
    console.log(raw_data);

    const flat_data = raw_data.map((segment) => segment['items']).flat();
    const left_data = flat_data.map((line) => [new Date(line['time']), line['left']]);
    const right_data = flat_data.map((line) => [new Date(line['time']), line['right']]);
    const altitude_data = flat_data.map((line) => [new Date(line['time']), line['altitude']]);

    const labels = raw_data.map((segment) => {
        return {
            time: new Date(segment['items'][0]['time']),
            name: segment['stop1'],
            kop: segment['kop'],
        }
    });
    const last_segment = raw_data.slice(-1)[0];
    labels.push({
        time: new Date(last_segment['items'].slice(-1)[0]['time']),
        name: last_segment['stop2'],
        kop: false,
    })

    const annotation_lines = labels.map((label) => {
        return {
            type: 'line',
            xMin: label.time,
            xMax: label.time,
            borderColor: 'grey',
            borderWidth: 2,
            borderDash: [5, 15],
        }
    });
    const annotation_labels = labels.map((label) => {
        return {
            type: 'label',
            xValue: label.time,
            yValue: 0.8,
            backgroundColor: label.kop ? 'rgba(255,225,220,0.8)' : 'rgba(245,245,245, 0.8)',
            content: [label.name],
            font: {
                size: 13
            },
            rotation: -90,
            position: '40%',
        }
    });
    annotation_labels[annotation_labels.length - 1].position = '60%';
    const annotations = Object.assign({}, annotation_lines.concat(annotation_labels));

    const ctx_h = document.getElementById("chart-horizontal");
    new Chart(ctx_h, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'Links',
                    data: left_data,
                    borderColor: 'red',
                    pointStyle: false,
                },
                {
                    label: 'Rechts',
                    data: right_data,
                    borderColor: 'blue',
                    pointStyle: false,
                },
                {
                    label: 'Hoogte',
                    data: altitude_data,
                    borderColor: 'green',
                    pointStyle: false,
                }
            ]
        },
        options: {
            stepped: 'middle',
            animation: {
                duration: 0,
            },
            responsive: true,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        // parser: 'HH:mm',
                        unit: 'minute',
                        displayFormats: {minute: 'HH:mm'}
                    }
                },
                y: {
                    min: 0,
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                annotation: {
                    annotations: annotations,
                }
            }
        },
    });


    // TODO, niet >=
    const left_data_v = left_data
        .map(([time, value]) => value > 0 ? [-value, time] : [null, time]);
    const right_data_v = right_data
        .map(([time, value]) => value > 0 ? [value, time] : [null, time]);

    const annotation_lines_v = annotation_lines.map((old_item) => {
        const item = structuredClone(old_item);
        // noinspection JSSuspiciousNameCombination
        item.yMin = item.yMax = item.xMin;
        delete item.xMin;
        delete item.xMax;
        return item;
    });
    const annotation_labels_v = annotation_labels.map((old_item) => {
        const item = structuredClone(old_item);
        // noinspection JSSuspiciousNameCombination
        item.yValue = item.xValue;
        item.xValue = 0;
        item.position = {x: 'center', y: 'center'};
        delete item.rotation;
        return item;
    });
    annotation_labels_v[0].position.y = '0%';
    annotation_labels_v[annotation_labels_v.length - 1].position.y = '100%';
    const annotations_v = Object.assign({}, annotation_lines_v.concat(annotation_labels_v));

    const ctx_v = document.getElementById("chart-vertical");
    const duration = Number(document.getElementById("duration").innerText); // (duration in seconds)
    ctx_v.height = Math.max(460, duration / 30);
    new Chart(ctx_v, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'Links',
                    data: left_data_v,
                    borderColor: 'red',
                    pointStyle: false,
                },
                {
                    label: 'Rechts',
                    data: right_data_v,
                    borderColor: 'blue',
                    pointStyle: false,
                },
            ]
        },
        options: {
            maintainAspectRation: false,
            stepped: 'middle',
            animation: {
                duration: 0,
            },
            indexAxis: 'y',
            responsive: true,
            scales: {
                y: {
                    type: 'time',
                    time: {
                        // parser: 'HH:mm',
                        unit: 'minute',
                        displayFormats: {minute: 'HH:mm'}
                    },
                    reverse: true,
                    ticks: {
                        stepSize: 15,
                    },
                },
                x: {
                    min: -1,
                    max: 1,
                    ticks: {
                        callback: (value) => Math.abs(value),
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
                annotation: {
                    annotations: annotations_v,
                }
            }
        },
    });
</script>
</body>
</html>